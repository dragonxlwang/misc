#!/bin/sh

## ========================================================================== ##
#       ______   ______    __        ______   .______          _______.        #
#      /      | /  __  \  |  |      /  __  \  |   _  \        /       |        #
#     |  ,----'|  |  |  | |  |     |  |  |  | |  |_)  |      |   (----`        #
#     |  |     |  |  |  | |  |     |  |  |  | |      /        \   \            #
#     |  `----.|  `--'  | |  `----.|  `--'  | |  |\  \----.----)   |           #
#      \______| \______/  |_______| \______/  | _| `._____|_______/            #
## ========================================================================== ##
function yellowecho { echo -e "\033[1;33m${1}\033[0m" }
function blueecho { echo -e "\033[1;36m${1}\033[0m" }
function redecho { echo -e "\033[1;31m${1}\033[0m" }
function greenecho { echo -e "\033[1;32m${1}\033[0m" }
ANSI_COLOR_RED="\033[31m"   # \e vs \033
ANSI_COLOR_RESET="\033[0m"

## ========================================================================== ##
#               ___       __       __       ___           _______.             #
#              /   \     |  |     |  |     /   \         /       |             #
#             /  ^  \    |  |     |  |    /  ^  \       |   (----`             #
#            /  /_\  \   |  |     |  |   /  /_\  \       \   \                 #
#           /  _____  \  |  `----.|  |  /  _____  \  .----)   |                #
#          /__/     \__\ |_______||__| /__/     \__\ |_______/                 #
## ========================================================================== ##
function work { tmux new -AD -s $(hostname -s)-main }
## ls -A: List all entries except for . and ...
## zsh f expansion flag to split on newline: arr_of_lns=("${(@f)$(my_cmd)}")
## @: In double quotes, array elements are put into separate words.
##    E.g., ‘"${(@)foo}"’ is equivalent to ‘"${foo[@]}"’ and ‘"${(@)foo[1,2]}"’
##    is the same as ‘"$foo[1]" "$foo[2]"’.
##    This is distinct from field splitting by the f, s or z flags, which still
##    applies within each array element.
## unix.stackexchange.com/questions/28854/list-elements-with-spaces-in-zsh
alias dir_size='for f in "${(@f)$(ls -A)}"; do du -sh $f; done;'
## show history with time, increase history size
## https://github.com/robbyrussell/oh-my-zsh/issues/739
## ./.oh-my-zsh/lib/history.zsh
## "mm/dd/yyyy":  -f
## "dd.mm.yyyy":  -E
## "yyyy-mm-dd":  -i
## HISTSIZE is the maximum number of lines that are kept in a session and
## SAVEHIST is the maximum number of lines that are kept in the history file.
alias history='fc -i -l 1'
# oh-my-zsh/plugins/history/history.plugin.zsh
function hs { history | grep $* }
alias hsi='hs -i'
# real remove vs save remove
alias rrm='/bin/rm -v'
function rm {
  local ret=""
  ret=$(mv --verbose -f --backup=numbered \
        --target-directory ${HOME}/.Trash/ "$@")
  echo -e $ANSI_COLOR_RED$ret$ANSI_COLOR_RESET
  local reg=""
  local f1=""
  local f2=""
  local fp="${HOME}/.Trash/rm.undo"
  echo "#!/bin/sh" > $fp
  for l in ${(f)ret}; do
    reg='s/^(.*) -> (.*)$/\1/p'
    f1=$(echo $l | sed -rn $reg)
    f1=${f1:1:${#f1}-2}
    reg='s/^(.*) -> (.*)$/\2/p'
    f2=$(echo $l | sed -rn $reg)
    f2=$(echo $f2 | sed -r 's/ \(backup: .*\)//')
    f2=${f2:1:${#f2}-2}
    [[ $f1 != /* ]] && f1="$PWD/$f1"
    echo "# \"$f1\" -> \"$f2\"" >> $fp
    echo "mv \"$f2\" \"$f1\"" >> $fp
    echo "echo \"\\033[1;33mmv \\\"$f2\\\" \\\"$f1\\\"\\033[0m\"" >> $fp
  done
}
function undo {
  local fp="${HOME}/.Trash/rm.undo"
  /bin/sh $fp
}
alias empty_trash='find ~/.Trash -mindepth 1 -delete -print'
# remove the following
## all mac .DS_store/.localized files in current directory recursively
function rm_mac_hidden_files {
  local clean_place=${*:-'.'}
  find $clean_place -name '*.DS_Store'  -type f -delete -print
  find $clean_place -name '*.localized' -type f -delete -print
}
## all python .py[co] files and __pycache__ dirs
alias rm_python_compiled_files="pyclean"
function rm_python_compiled_files_no_recursion {
  local clean_place=${*:-'.'}
  find $clean_place -maxdepth 1 -type f -name "*.py[co]" -delete
  find $clean_place -maxdepth 1 -type d -name "__pycache__" -delete
}
## all vim swap .sw[pon]
function rm_vim_swap_files {
  local clean_place=${*:-'.'}
  find $clean_place -name '*.sw[pon]'  -type f -delete -print
}
function rm_vim_swap_files_no_recursion {
  local clean_place=${*:-'.'}
  find $clean_place -maxdepth 1 -name '*.sw[pon]'  -type f -delete -print
}
alias cls='printf "\033c"'
alias echo_path='echo ${PATH//:/"\n"}'
alias ll="ls -alh"
function lll { ll $@ --color=always | less }
alias lllt="lll -t"
function lls { ll | grep $* }
alias llsi='lls -i'
function ll_symlink {
    [[ $# -eq 1 ]] && { ll $1 | grep "\->"} || {ll | grep "\->"} }
function kill_jobs { for i in $(seq 1 $(jobs | wc -l)); do kill %$i; done }
alias kill_tmux='tmux kill-session'
function jump { if [[ $# -eq 1 ]]; then cd $1; fi; cd $(pwd -P); }
function follow { cd $(dirname $(readlink -f $1)) }
alias jp="jump"
alias fl="follow"
function exe_remote_script {
  eval "$(curl -fsSL $1)"
}

## ========================================================================== ##
#       _______.  ______ .______      __  .______   .___________.    _______.  #
#      /       | /      ||   _  \    |  | |   _  \  |           |   /       |  #
#     |   (----`|  ,----'|  |_)  |   |  | |  |_)  | `---|  |----`  |   (----`  #
#      \   \    |  |     |      /    |  | |   ___/      |  |        \   \      #
#  .----)   |   |  `----.|  |\  \----|  | |  |          |  |    .----)   |     #
#  |_______/     \______|| _| `._____|__| | _|          |__|    |_______/      #
#                    _______  _______   __  .___________.                      #
#                   |   ____||       \ |  | |           |                      #
#                   |  |__   |  .--.  ||  | `---|  |----`                      #
#                   |   __|  |  |  |  ||  |     |  |                           #
#                   |  |____ |  '--'  ||  |     |  |                           #
#                   |_______||_______/ |__|     |__|                           #
#              __    __  .______    _______       ___   .___________._______   #
#    ___      |  |  |  | |   _  \  |       \     /   \  |           |   ____|  #
#   ( _ )     |  |  |  | |  |_)  | |  .--.  |   /  ^  \ `---|  |----|  |__     #
#   / _ \/\   |  |  |  | |   ___/  |  |  |  |  /  /_\  \    |  |    |   __|    #
#  | (_>  <   |  `--'  | |  |      |  '--'  | /  _____  \   |  |    |  |____   #
#   \___/\/    \______/  | _|      |_______/ /__/     \__\  |__|    |_______|  #
## ========================================================================== ##
##-------------------------------== profiles ==-------------------------------##
function edit_then_source { vim $1; yellowecho "sourcing $1"; source $1; }
function ed_profile {
  local f1="${HOME}/misc/dotfiles/lib/.profile_wangxl"
  local f2="${HOME}/misc/dotfiles/lib/.profile_wangxl_darwin"
  local f3="${HOME}/misc/dotfiles/lib/.profile_wangxl_linux"
  vim $f1 $f2 $f3
  yellowecho "sourcing ~/.profile_wangxl"
  source ${HOME}/.profile_wangxl
}
function ed_profile_darwin {
  edit_then_source ${HOME}/misc/dotfiles/lib/.profile_wangxl_darwin
}
function ed_profile_linux {
  edit_then_source ${HOME}/misc/dotfiles/lib/.profile_wangxl_linux
}
function up_profile {
  yellowecho "sourcing ${HOME}/.profile_wangxl"
  source ${HOME}/.profile_wangxl
  yellowecho "sourcing ${HOME}/.tmux.conf"
  tmux source-file ${HOME}/.tmux.conf
}
##----------------------------== tmux conf, tmp ==----------------------------##
alias ed_tmux="vim ~/.tmux.conf; tmux source-file ~/.tmux.conf"
function init_tmux_tpm {
  if [[ ! -d ~/.tmux/plugins/tpm/.git ]] && \
     [[ ! -f ~/.tmux/plugins/tpm/.git ]]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    echo "\n\tRead about tmux tpm configuration for vundle" \
         " at https://github.com/tmux-plugins/tpm\n"
    yellowecho "prefix + I : install new plugins"
    yellowecho "prefix + U : updates plugin(s)"
    yellowecho "prefix + alt + u : remove/uninstall plugins not on the list"
  fi
}
alias up_tmux_tpm="init_tmux_tpm; ~/.tmux/plugins/tpm/bin/install_plugins"
alias clean_tmux_tmp="init_tmux_tpm; ~/.tmux/plugins/tpm/bin/clean_plugins"
##-------------------------------== git:misc ==-------------------------------##
function ed_misc {
  local diff_cmd=" | vertical all | windo diffthis"
  local cmd1='args ~/misc/dotfiles/lib/.profile_wangxl | '
  cmd1+='bel split ~/misc/dotfiles/lib/.profile_wangxl_darwin | '
  cmd1+='bel vsplit ~/misc/dotfiles/lib/.profile_wangxl_linux | wincmd w'
  local cmd2='e ~/misc/dotfiles/lib/.tmux.conf'
  local cmd3='e ~/misc/dotfiles/lib/.vimrc |'
  cmd3+='bel vsplit ~/misc/dotfiles/lib/.vimrc.bundles'
  vim -c "$cmd1" -c "tabnew" \
      -c "$cmd2" -c "tabnew" \
      -c "$cmd3" -c "tabn1"
  yellowecho "sourcing ~/.profile_wangxl"
  source ${HOME}/.profile_wangxl
  yellowecho "sourcing ~/.tmux.conf"
  tmux source-file ${HOME}/.tmux.conf
}
function up_misc {
  pushd ${HOME}/misc > /dev/null
  if [[ -z $(git status --porcelain) ]]; then
    ggpur
  else
    xg_st
    redecho "There is uncommitted changes. Abort..."
  fi
  popd > /dev/null
}
function ed_scripts {
  local f1="${HOME}/misc/dotfiles/scripts/setup_symlinks.sh"
  local f2="${HOME}/misc/dotfiles/scripts/quick_install.sh"
  vim $f1 $f2
}
function up_symlinks {
  local opt=""
  [[ $(uname) == "Darwin" ]] && opt="mac"
  [[ $(uname) == "Linux" ]] && opt="timan"
  yellowecho "setup symlinks for $opt"
  ${HOME}/misc/dotfiles/scripts/setup_symlinks.sh $opt --no-confirm
}
##--------------------------------== vundle ==--------------------------------##
# oh-my-zsh/plugins/vundle/vundle.plugin.zsh
# https://github.com/VundleVim/Vundle.vim
function init_vundle {
  if [[ ! -d ~/.vim/bundle/Vundle.vim/.git ]] && \
     [[ ! -f ~/.vim/bundle/Vundle.vim/.git ]]; then
    git clone https://github.com/VundleVim/Vundle.vim.git \
      ~/.vim/bundle/Vundle.vim
    echo "\n\tRead about vim configuration for vundle" \
         " at https://github.com/VundleVim/Vundle.vim\n"
  fi
}
alias up_vundle="init_vundle; vim +PluginInstall +qall"
alias update_vundle="init_vundle; vim +PluginInstall! +qall"
alias clean_vundle="init_vundle; vim +PluginClean! +qall"

## ========================================================================== ##
#                     ________      _______. __    __                          #
#                    |       /     /       ||  |  |  |                         #
#                    `---/  /     |   (----`|  |__|  |                         #
#                       /  /       \   \    |   __   |                         #
#                      /  /----.----)   |   |  |  |  |                         #
#                     /________|_______/    |__|  |__|                         #
## ========================================================================== ##
if [[ $options[extended_glob] == off ]]; then setopt extended_glob; fi
# Enable hidden files completion
# https://github.com/robbyrussell/oh-my-zsh/pull/4489#issuecomment-196992974
_comp_options+=(globdots)

## ========================================================================== ##
#                      _______  __  .___________.                              #
#                     /  _____||  | |           |                              #
#                    |  |  __  |  | `---|  |----`                              #
#                    |  | |_ | |  |     |  |                                   #
#                    |  |__| | |  |     |  |                                   #
#                     \______| |__|     |__|                                   #
## ========================================================================== ##
function xg_sl {
  local option=""
  # by default, zsh does not split word
  # three ways to enable spliting safely
  # ${=a}
  # ${(@s: :)a} ## retain empty strings with @
  # eval "(${a})"
  if [[ $# -eq 0 ]]; then option="-10"; else eval "option=(${@})"; fi
  # replace -10 with --all
  git --no-pager log $option --branches --graph --decorate --all
}
function xg_sl_outgoing {
  git fetch
  git --no-pager log --branches --decorate --graph origin/master.. $@
}
function xg_sl_incoming {
  git fetch
  git --no-pager log --branches --decorate --graph ..origin/master $@
}
function xg_ls {
  git ls-tree -r --name-only ${@:-HEAD}
}
alias xg_ls_ignored="git ls-files --ignored --exclude-standard --others"
alias xg_ls_untracked="git ls-files --exclude-standard --others"
alias xg_st='git status'
function xg_rm_last_commit {
  local ans=""
  echo -ne "${ANSI_COLOR_RED}Delete Last Commit [Y/N]?${ANSI_COLOR_RESET} "
  read ans
  ans=$(echo ${ans} | tr "[:upper:]" "[:lower:]")
  if [[ $ans == yes || $ans == y ]]; then
    yellowecho "deleting..."
    git reset --hard "HEAD^"
  else
    yellowecho "do nothing, exit..."
  fi
}
alias xg_rk_last_commit='git reset --soft "HEAD^"'
alias xg_browse='hub browse'
alias xg_list_remote_repo_branch='git ls-remote origin'
alias xg_show_remote_repo='git remote show origin'
alias xg_dry_run_featch='git fetch --dry-run'
function xg_check_remote_up_2_date {
  if [[ -z $(git fetch --dry-run 3>&2 2>&1 1>&3) ]]
  then
    blueecho "Git: up to date"
  else
    redecho "Git: need update"
  fi
}
alias xg_diff="git diff HEAD"
alias xg_ca="git commit -v -a --amend --no-edit"
function github_short_url {
  curl -isS https://git.io -F "url=$1" | sed -rn 's/^Location: (.*)$/\1/p'
}
function github_short_url_to_clipboard {
  local url="$(github_short_url $1)"
  echo $url | pbcopy
  echo $url
}

## ========================================================================== ##
#             .______   .______      ___________    __    ____                 #
#             |   _  \  |   _  \    |   ____\   \  /  \  /   /                 #
#             |  |_)  | |  |_)  |   |  |__   \   \/    \/   /                  #
#             |   _  <  |      /    |   __|   \            /                   #
#             |  |_)  | |  |\  \----|  |____   \    /\    /                    #
#             |______/  | _| `._____|_______|   \__/  \__/                     #
## ========================================================================== ##
# homebrew api token
if [[ -f  ~/Dropbox/Tools/secrets/homebrew_github_api_token ]]; then
  export HOMEBREW_GITHUB_API_TOKEN=$(cat \
    ~/Dropbox/Tools/secrets/homebrew_github_api_token)
else
  redecho "cannot find file ~/Dropbox/Tools/secrets/homebrew_github_api_token"
  redecho "fix dropbox missing problem"
fi

## ========================================================================== ##
#                   .___  ___.  __       _______.  ______                      #
#                   |   \/   | |  |     /       | /      |                     #
#                   |  \  /  | |  |    |   (----`|  ,----'                     #
#                   |  |\/|  | |  |     \   \    |  |                          #
#                   |  |  |  | |  | .----)   |   |  `----.                     #
#                   |__|  |__| |__| |_______/     \______|                     #
## ========================================================================== ##
alias run_matlab="matlab -nodesktop -nosplash -r"

## ========================================================================== ##
#             ___________    ____  _______.___________._______ .___  ___.      #
#            /       \   \  /   / /       |           |   ____||   \/   |      #
#           |   (----`\   \/   / |   (----`---|  |----|  |__   |  \  /  |      #
#            \   \     \_    _/   \   \       |  |    |   __|  |  |\/|  |      #
#        .----)   |      |  | .----)   |      |  |    |  |____ |  |  |  |      #
#        |________..________| ________/ ______|___   _____________| ______     #
#         /       ||   _  \  |   ____| /      ||  | |   ____||  |  /      |    #
#        |   (----`|  |_)  | |  |__   |  ,----'|  | |  |__   |  | |  ,----'    #
#         \   \    |   ___/  |   __|  |  |     |  | |   __|  |  | |  |         #
#     .----)   |   |  |      |  |____ |  `----.|  | |  |     |  | |  `----.    #
#     |_______/    | _|      |_______| \______||__| |__|     |__|  \______|    #
## ========================================================================== ##
if [[ $(uname) == "Darwin" ]]; then
  source ${HOME}/misc/dotfiles/lib/.profile_wangxl_darwin
elif [[ $(uname) == "Linux" ]]; then
  source ${HOME}/misc/dotfiles/lib/.profile_wangxl_linux
fi
